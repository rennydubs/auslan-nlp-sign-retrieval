{% extends "base.html" %}

{% block title %}Auslan Sign Retrieval - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-4">
            <h1><i class="fas fa-hands"></i> Auslan Sign Retrieval System</h1>
            <p class="lead">Enter text to find corresponding Auslan signs for fitness coaching</p>
        </div>

        <!-- Input Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="signForm">
                    <div class="mb-3">
                        <label for="textInput" class="form-label">Enter text to translate to Auslan signs:</label>
                        <textarea class="form-control" id="textInput" rows="3" 
                                placeholder="e.g., 'Warm up before lifting weights' or 'Let's exercise and build muscle strength'"
                                required></textarea>
                    </div>
                    
                    <!-- Options Panel -->
                    <div class="option-panel">
                        <h6><i class="fas fa-cog"></i> Processing Options</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="removeStops">
                                    <label class="form-check-label" for="removeStops">
                                        Remove stop words
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useStemming">
                                    <label class="form-check-label" for="useStemming">
                                        Enable stemming
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useSemantic" checked>
                                    <label class="form-check-label" for="useSemantic">
                                        Use semantic matching
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useIntelligent" checked>
                                    <label class="form-check-label" for="useIntelligent">
                                        Use intelligent matching
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label for="semanticThreshold" class="form-label">Semantic threshold: <span id="thresholdValue">0.5</span></label>
                                    <input type="range" class="form-range" id="semanticThreshold" min="0.3" max="0.9" step="0.1" value="0.5">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" id="evaluateBtn">
                            <i class="fas fa-chart-bar"></i> Run Evaluation
                        </button>
                        <button type="button" class="btn btn-outline-info me-md-2" id="statusBtn">
                            <i class="fas fa-info-circle"></i> AI Status
                        </button>
                        <button type="submit" class="btn btn-primary" id="processBtn">
                            <i class="fas fa-search"></i> Find Signs
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-2">Processing your text...</p>
        </div>

        <!-- Results Section -->
        <div id="results" style="display: none;">
            <!-- Stats Card -->
            <div class="stats-card">
                <div class="row text-center">
                    <div class="col-3">
                        <h3 id="totalTokens">0</h3>
                        <small>Total Words</small>
                    </div>
                    <div class="col-3">
                        <h3 id="signsFound">0</h3>
                        <small>Signs Found</small>
                    </div>
                    <div class="col-3">
                        <h3 id="coverageRate">0%</h3>
                        <small>Coverage</small>
                    </div>
                    <div class="col-3">
                        <h3 id="processingTime">0ms</h3>
                        <small>Process Time</small>
                    </div>
                </div>
            </div>

            <!-- Matched Signs -->
            <div id="matchedSigns"></div>

            <!-- Unmatched Words -->
            <div id="unmatchedWords" style="display: none;">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Unmatched Words:</h6>
                    <p id="unmatchedList" class="mb-0"></p>
                    <small class="text-muted">Consider adding these to the dictionary or using different words.</small>
                </div>
            </div>

            <!-- Match Statistics -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-chart-pie"></i> Match Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h5 text-success" id="exactMatches">0</div>
                                <small>Exact Matches</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h5 text-warning" id="synonymMatches">0</div>
                                <small>Synonym Matches</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h5 text-info" id="semanticMatches">0</div>
                                <small>Semantic Matches</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h5 text-danger" id="unmatchedCount">0</div>
                                <small>Unmatched</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Examples -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> Quick Examples</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Fitness Instructions:</h6>
                        <ul class="list-unstyled">
                            <li><a href="#" class="example-link">Warm up before lifting weights</a></li>
                            <li><a href="#" class="example-link">Focus on your chest and arms today</a></li>
                            <li><a href="#" class="example-link">Remember to breathe during exercise</a></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Basic Conversations:</h6>
                        <ul class="list-unstyled">
                            <li><a href="#" class="example-link">Hello, how are you today?</a></li>
                            <li><a href="#" class="example-link">I need help finding the toilet</a></li>
                            <li><a href="#" class="example-link">Thank you and goodbye</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Update threshold display
    $('#semanticThreshold').on('input', function() {
        $('#thresholdValue').text($(this).val());
    });

    // Example buttons
    $(document).on('click', '.example-link', function(e) {
        e.preventDefault();
        const text = $(this).text().trim();
        $('#textInput').val(text).focus();
    });

    // Clear button
    $('#clearBtn').click(function() {
        $('#textInput').val('').focus();
        $('#results').hide();
        $('#searchSuggestions').hide();
    });

    // Random example button
    $('#randomBtn').click(function() {
        const examples = [
            "Warm up before lifting weights",
            "Focus on your chest and arms today",
            "Remember to breathe during exercise",
            "I need more time to rest",
            "Hello, how are you today?",
            "I need help finding the toilet",
            "Thank you and goodbye",
            "Let's eat good food together",
            "Many people exercise to stay strong",
            "Drink more water during workout time",
            "I feel happy and strong today",
            "Come help me lift these weights"
        ];
        const randomExample = examples[Math.floor(Math.random() * examples.length)];
        $('#textInput').val(randomExample).focus();
    });

    // Search suggestions
    const commonPhrases = [
        "warm up", "cool down", "lift weights", "build muscle", "drink water",
        "exercise time", "rest break", "stretch arms", "strong legs", "breathe deeply",
        "many people", "more food", "good day", "help me", "thank you",
        "hello friend", "goodbye see you", "happy today", "sad feeling"
    ];

    $('#textInput').on('input', function() {
        const query = $(this).val().toLowerCase().trim();
        const suggestions = $('#searchSuggestions');

        if (query.length < 2) {
            suggestions.hide();
            return;
        }

        const matches = commonPhrases.filter(phrase =>
            phrase.includes(query) || query.includes(phrase.split(' ')[0])
        ).slice(0, 5);

        if (matches.length > 0) {
            const suggestionHtml = matches.map(phrase =>
                `<div class="suggestion-item" data-text="${phrase}">
                    <i class="fas fa-search me-2 text-muted"></i>${phrase}
                </div>`
            ).join('');

            suggestions.html(suggestionHtml).show();
        } else {
            suggestions.hide();
        }
    });

    // Handle suggestion clicks
    $(document).on('click', '.suggestion-item', function() {
        const text = $(this).data('text');
        const currentText = $('#textInput').val();
        const words = currentText.split(' ');
        words[words.length - 1] = text;
        $('#textInput').val(words.join(' ') + ' ').focus();
        $('#searchSuggestions').hide();
    });

    // Hide suggestions when clicking outside
    $(document).click(function(e) {
        if (!$(e.target).closest('#textInput, #searchSuggestions').length) {
            $('#searchSuggestions').hide();
        }
    });

    // Form submission
    $('#signForm').submit(function(e) {
        e.preventDefault();
        processText();
    });

    // Evaluation button
    $('#evaluateBtn').click(function() {
        runEvaluation();
    });

    // AI Status button
    $('#statusBtn').click(function() {
        checkAIStatus();
    });

    function processText() {
        const text = $('#textInput').val().trim();
        if (!text) return;

        const options = {
            remove_stops: $('#removeStops').is(':checked'),
            use_semantic: $('#useSemantic').is(':checked'),
            use_stemming: $('#useStemming').is(':checked'),
            semantic_threshold: parseFloat($('#semanticThreshold').val()),
            use_intelligent_matching: $('#useIntelligent').is(':checked')
        };

        $('#loading').show();
        $('#results').hide();

        const startTime = Date.now();

        $.ajax({
            url: '/api/process',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                text: text,
                options: options
            }),
            success: function(data) {
                const endTime = Date.now();
                displayResults(data, endTime - startTime);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'An error occurred';
                alert('Error: ' + error);
            },
            complete: function() {
                $('#loading').hide();
            }
        });
    }

    function displayResults(data, processingTime) {
        // Update stats
        $('#totalTokens').text(data.total_tokens);
        $('#signsFound').text(data.signs_found);
        $('#coverageRate').text((data.coverage_stats.coverage_rate * 100).toFixed(1) + '%');
        $('#processingTime').text(processingTime + 'ms');

        // Update match statistics
        const stats = data.coverage_stats;
        $('#exactMatches').text(stats.exact_matches);
        $('#synonymMatches').text(stats.synonym_matches);
        $('#semanticMatches').text(stats.semantic_matches);
        $('#unmatchedCount').text(stats.unmatched_tokens);

        // Display matched signs
        const matchedContainer = $('#matchedSigns');
        matchedContainer.empty();

        if (data.successful_matches.length > 0) {
            data.successful_matches.forEach(function(match, index) {
                const card = createMatchCard(match, index + 1);
                matchedContainer.append(card);
            });
        }

        // Display unmatched words
        if (data.failed_matches.length > 0) {
            const unmatchedWords = data.failed_matches.map(m => m.word).join(', ');
            $('#unmatchedList').text(unmatchedWords);
            $('#unmatchedWords').show();
        } else {
            $('#unmatchedWords').hide();
        }

        // Display NLP Analysis if available
        if (data.nlp_analysis) {
            displayNLPAnalysis(data.nlp_analysis);
        }

        // Display Phrase Analysis if available
        if (data.phrase_analysis) {
            displayPhraseAnalysis(data.phrase_analysis);
        }

        $('#results').show();
    }

    function displayNLPAnalysis(nlp) {
        // Create or update NLP analysis card
        let nlpCard = $('#nlpAnalysis');
        if (nlpCard.length === 0) {
            const nlpHtml = `
                <div class="card mt-3" id="nlpAnalysis">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-brain me-2"></i>AI Analysis</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <strong>Sentiment:</strong>
                                    <span id="sentimentLabel" class="badge"></span>
                                    <span id="sentimentScore" class="text-muted"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Emotion:</strong>
                                    <span id="emotionLabel" class="badge bg-warning"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Intent:</strong>
                                    <span id="intentLabel" class="badge bg-secondary"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <strong>Formality:</strong>
                                    <span id="formalityLabel" class="badge bg-light text-dark"></span>
                                </div>
                                <div class="mb-2" id="entitiesDiv" style="display: none;">
                                    <strong>Entities:</strong>
                                    <span id="entitiesList"></span>
                                </div>
                                <div class="mb-2" id="phrasesDiv" style="display: none;">
                                    <strong>Key Phrases:</strong>
                                    <span id="phrasesList" class="text-muted"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#results').prepend(nlpHtml);
        }

        // Update sentiment
        const sentimentClass = nlp.sentiment === 'positive' ? 'bg-success' :
                              nlp.sentiment === 'negative' ? 'bg-danger' : 'bg-secondary';
        $('#sentimentLabel').attr('class', `badge ${sentimentClass}`).text(nlp.sentiment);
        $('#sentimentScore').text(`(${nlp.sentiment_score.toFixed(2)})`);

        // Update emotion
        $('#emotionLabel').text(nlp.emotion);

        // Update intent
        $('#intentLabel').text(nlp.intent);

        // Update formality
        $('#formalityLabel').text(nlp.formality);

        // Update entities if available
        if (nlp.entities && nlp.entities.length > 0) {
            const entityBadges = nlp.entities.map(e =>
                `<span class="badge bg-primary me-1">${e.text} (${e.label})</span>`
            ).join('');
            $('#entitiesList').html(entityBadges);
            $('#entitiesDiv').show();
        } else {
            $('#entitiesDiv').hide();
        }

        // Update key phrases if available
        if (nlp.key_phrases && nlp.key_phrases.length > 0) {
            $('#phrasesList').text(nlp.key_phrases.slice(0, 3).join(', '));
            $('#phrasesDiv').show();
        } else {
            $('#phrasesDiv').hide();
        }
    }

    function displayPhraseAnalysis(phrase) {
        // Create or update phrase analysis card
        let phraseCard = $('#phraseAnalysis');
        if (phraseCard.length === 0) {
            const phraseHtml = `
                <div class="card mt-3" id="phraseAnalysis">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Phrase Analysis</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Type:</strong>
                                <span id="phraseType" class="badge bg-primary"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Confidence:</strong>
                                <span id="phraseConfidence" class="badge bg-info"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Grammar:</strong>
                                <span id="grammarStructure" class="text-muted small"></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#results').prepend(phraseHtml);
        }

        $('#phraseType').text(phrase.phrase_type);
        $('#phraseConfidence').text(`${(phrase.overall_confidence * 100).toFixed(1)}%`);
        $('#grammarStructure').text(phrase.grammar_structure);
    }

    function createMatchCard(match, index) {
        const signData = match.sign_data;
        const confidence = (match.confidence * 100).toFixed(1);
        const confidenceClass = match.confidence >= 0.8 ? 'high' : match.confidence >= 0.6 ? 'medium' : 'low';
        
        let videoHtml = '';
        if (signData && signData.video_url && signData.video_url.startsWith('media/')) {
            videoHtml = `
                <div class="video-container">
                    <video controls>
                        <source src="${signData.video_url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            `;
        }

        return `
            <div class="card match-card ${match.match_type}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                ${index}. ${match.word.toUpperCase()}
                                <span class="badge bg-secondary">${signData?.gloss || 'N/A'}</span>
                            </h5>
                            <p class="text-muted mb-2">
                                <i class="fas fa-tag"></i> ${match.match_type.charAt(0).toUpperCase() + match.match_type.slice(1)} Match
                                (${confidence}% confidence)
                            </p>
                            <div class="confidence-bar mb-2">
                                <div class="confidence-fill ${confidenceClass}" style="width: ${confidence}%"></div>
                            </div>
                            <p class="card-text">${signData?.description || 'No description available'}</p>
                            <div class="row">
                                <div class="col-sm-6">
                                    <small class="text-muted">
                                        <i class="fas fa-folder"></i> Category: ${signData?.category || 'N/A'}
                                    </small>
                                </div>
                                <div class="col-sm-6">
                                    ${signData?.synonyms ? `
                                        <small class="text-muted">
                                            <i class="fas fa-list"></i> Synonyms: ${signData.synonyms.slice(0, 3).join(', ')}
                                        </small>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            ${videoHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function runEvaluation() {
        $('#loading').show();
        $('#results').hide();

        const options = {
            remove_stops: $('#removeStops').is(':checked'),
            use_semantic: $('#useSemantic').is(':checked'),
            use_stemming: $('#useStemming').is(':checked'),
            semantic_threshold: parseFloat($('#semanticThreshold').val()),
            use_intelligent_matching: $('#useIntelligent').is(':checked')
        };

        $.ajax({
            url: '/api/evaluate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                options: options
            }),
            success: function(data) {
                alert(`Evaluation Complete!\nAverage Coverage: ${(data.average_coverage * 100).toFixed(1)}%\nTotal Tests: ${data.total_tests}`);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'An error occurred';
                alert('Error: ' + error);
            },
            complete: function() {
                $('#loading').hide();
            }
        });
    }

    function checkAIStatus() {
        $.ajax({
            url: '/api/models/status',
            method: 'GET',
            success: function(data) {
                displayAIStatus(data);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to check AI status';
                alert('Error: ' + error);
            }
        });
    }

    function displayAIStatus(status) {
        const modal = `
            <div class="modal fade" id="aiStatusModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-robot me-2"></i>AI Model Status
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-12">
                                    <h6>Core System</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-circle ${status.spacy_available ? 'text-success' : 'text-danger'}"></i> spaCy NLP: ${status.spacy_available ? 'Available' : 'Not Available'}</li>
                                        <li><i class="fas fa-circle ${status.intelligent_matching_available ? 'text-success' : 'text-danger'}"></i> Intelligent Matching: ${status.intelligent_matching_available ? 'Available' : 'Not Available'}</li>
                                        <li><i class="fas fa-circle text-success"></i> Total Signs: ${status.total_signs}</li>
                                    </ul>

                                    <h6>AI Models</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-circle ${status.semantic_model_available ? 'text-success' : 'text-danger'}"></i> Semantic Similarity: ${status.semantic_model_available ? 'Available' : 'Not Available'}</li>
                                        <li><i class="fas fa-circle ${status.sentiment_model_available ? 'text-success' : 'text-danger'}"></i> DistilBERT Sentiment: ${status.sentiment_model_available ? 'Available' : 'Not Available'}</li>
                                        <li><i class="fas fa-circle ${status.emotion_model_available ? 'text-success' : 'text-danger'}"></i> RoBERTa Emotion: ${status.emotion_model_available ? 'Available' : 'Not Available'}</li>
                                    </ul>

                                    <div class="alert alert-info">
                                        <strong>System Version:</strong> ${status.system_version}<br>
                                        <strong>Recommendation:</strong> ${getRecommendation(status)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        $('#aiStatusModal').remove();

        // Add new modal and show it
        $('body').append(modal);
        $('#aiStatusModal').modal('show');
    }

    function getRecommendation(status) {
        const issues = [];
        if (!status.spacy_available) issues.push('Install spaCy');
        if (!status.semantic_model_available) issues.push('Install sentence-transformers');
        if (!status.sentiment_model_available) issues.push('Check transformers installation');
        if (!status.emotion_model_available) issues.push('Emotion model loading failed');

        if (issues.length === 0) {
            return 'All AI features are working perfectly! ðŸŽ‰';
        } else {
            return 'Some AI features are disabled. ' + issues.join(', ') + '.';
        }
    }
});

// Video control functions
function toggleVideo(videoId) {
    const video = document.getElementById(videoId);
    const icon = document.getElementById(`icon_${videoId}`);

    if (video.paused) {
        video.play();
        icon.className = 'fas fa-pause';
    } else {
        video.pause();
        icon.className = 'fas fa-play';
    }
}

function restartVideo(videoId) {
    const video = document.getElementById(videoId);
    video.currentTime = 0;
    if (!video.paused) {
        video.play();
    }
}

function toggleMute(videoId) {
    const video = document.getElementById(videoId);
    const icon = document.getElementById(`mute_${videoId}`);

    video.muted = !video.muted;
    icon.className = video.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
}

function playAllVideos() {
    const videos = document.querySelectorAll('.sign-video');
    videos.forEach((video, index) => {
        setTimeout(() => {
            video.currentTime = 0;
            video.play();
        }, index * 1000); // Stagger playback by 1 second
    });
}

// Add video event listeners when videos are loaded
$(document).on('loadedmetadata', '.sign-video', function() {
    const video = this;
    const videoId = video.id;
    const icon = document.getElementById(`icon_${videoId}`);

    video.addEventListener('ended', function() {
        icon.className = 'fas fa-play';
    });

    video.addEventListener('play', function() {
        icon.className = 'fas fa-pause';
    });

    video.addEventListener('pause', function() {
        icon.className = 'fas fa-play';
    });
});

// Add smooth animations
$(document).ready(function() {
    // Animate stats cards
    $('#results').on('show', function() {
        $('.stats-card').addClass('fade-in');
        $('.match-card').each(function(index) {
            $(this).delay(index * 100).queue(function() {
                $(this).addClass('fade-in').dequeue();
            });
        });
    });
});
</script>
{% endblock %}